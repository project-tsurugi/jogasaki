# 型変換メモ

2024-03-07 kurosawa

## 本文書について

型変換(に伴う値の変換)の仕様はtakatori文書の[キャスト][キャスト]に準じるが、文書の補足と仕様詳細を記述する

## takatori文書の捕捉

### overflowエラー

- takatori文書 [キャスト][キャスト] ではcast処理において実行時エラー(overflow)が発生するという記述があるが、最新の仕様ではoverflowエラーは発生しないものとしている
- cast先の型がとり得る値の範囲外となった場合は範囲の最大値または最小値に変換される。この際、精度は失われる。

### `NaN`の浮動小数以外への変換

- 浮動小数点型(float4またはfloat8)は `NaN` を含むことがあるが、これを整数型やdecimalへ変換しようとした場合は arithmetic errorとなる
- takatori文書の[キャスト]と[代入変換]の表にはまだ反映されていない(float4/float8から整数型への変換は`v`と記載されている)

### 代入変換とキャスト変換

- 値の変換ロジックは代入変換もキャスト変換も共通
- 変換が許可される型の組がキャスト変換と代入変換で異なり、[キャスト][キャスト]と[代入変換][代入変換]の表に記述されている
  - 原則として代入変換は暗黙的に行われるので精度を失う代入変換はエラーになるようになっている

### 浮動小数型の代入変換

- [代入変換][代入変換]の表でfloat4/float8と数値型の間の変換は `v`であり、精度を失う場合でもエラーにならないとしているが、最新の仕様では精度を失う場合はエラーにすることにしている(`D`相当)

## 仕様詳細

### 型の長さについて

変換先の型が長さをもつ場合の意味について記載する

#### `CHAR(*)`

- `CHAR`に任意長 `*` を指定することはできない
  - パディング長をきめられないため
  - 列定義とキャストで共通

#### `CHAR`

- カッコなしの`CHAR`を指定すると `CHAR(1)`の意味となる
  - 列定義とキャストで共通

#### `VARCHAR(*)`

- `VARCHAR`には任意長 `*` を指定することができる
  - キャスト式の場合、長さに制限のない文字列型
  - 列定義の場合、既定の最大長で置き換えられる(ストレージサイズの制約)

#### `VARCHAR`

- カッコなしの`VARCHAR`を指定するとコンパイルエラー
  - 列定義とキャストで共通

#### `DECIMAL(p,s)`, `DECIMAL`

- 文書[SQL DECIMAL](decimal_impl.md)を参照

### 浮動小数へ変換時のunderflow/overflow

- 変換先の型がfloat4またはfloat8で、値が `-std::numeric_limits::min()` と `std::numeric_limits::min()` の間(端点を含まない)の場合、underflowが発生する。この場合、変換結果は負又は正のゼロとし、精度は失われるものとする。

- 変換先の型がfloat4またはfloat8で、値が `-std::numeric_limits::max()` 未満か `std::numeric_limits::max()` を越える場合overflowが発生する。この場合、変換結果は負又は正の無限大とし、精度は失われるものとする。

### 特殊値の文字列表現

浮動小数点型(float4またはfloat8)の特殊値を文字列型へ変換した場合の表現は下記の通り
- 非数(not a number): `NaN`
  (負の符号をもつ非数も `NaN` に変換され `-NaN` とはならない)
- 正の無限大: `Infinity`
- 負の無限大: `-Infinity`

(PostgresqlやJava、mpdecimalの表現に合わせている。C++の`std::to_string`は異なるので実装時注意)

逆に文字列から特殊値へ変換する場合は次の規則に従う

  - 符号の有無は問わない。省略時は正の符号として扱う
  - 符号を除いた部分が `NaN` または `INF` または `Infinity` とcase-insensitiveで等しい文字列のみが受け入れられる
  - 先頭や末尾の空白からなる文字列は無視される(文字列から変換時の一般的なルール)

### 文字列表現からの変換

- 文字列から数値への変換の場合、基本的に文字列を `DECIMAL(*,*)` の値へ変換し、さらに変換先の型へ変換する、ただし下記の特殊値の場合をのぞく

- INF, NaNなど特殊値を表す文字列は `DECIMAL(*,*)` に含まれない。この場合変換先の型によって挙動が異なる
  - 変換先が整数型やdecimalの場合、arithmetic error
  - 変換先が浮動小数型(float4/float8)の場合、文字列があらわす特殊値を結果とする
    - ただしNaNの符号は正のもののみを扱い、`-nan` の変換結果は正の符号をもつNaNになる
  - これらの文字列から有限値を生成することはしない

- 非特殊値を表す文字列の場合、桁数と指数が `DECIMAL(*,*)` の妥当な範囲内であることが必要
  - この範囲に収まらない場合は format error (扱える数値のフォーマットでない)
  - 文字列を `decimal::Decimal` 経由で `triple` に変換して確認する

- `DECIMAL(*,*)`からの変換は下記セクション参照

### 浮動小数点数と `DECIMAL(*,*)` の変換

- 浮動小数点数(float4/float8)は一旦文字列に変換してから上記手順で `DECIMAL(*,*)` へ変換する
  - mpdecimalが浮動小数点数と `decimal::Decimal` 間の変換をサポートしていないため
  - 実装メモ：
    - `DECIMAL(*,*)` からfloat4/float8 : `decimal::Decimal::to_sci` および `std::stof`/`std::stod`
    - float4/float8から `DECIMAL(*,*)` : `std::to_string` および `decimal::Decimal`コンストラクタ

### 数値型の`DECIMAL(*,*)` への変換

  1. 特殊値(Infinity, NaNなど)の場合は変換エラーとする
    - 文字列からの変換の場合は format error
    - 浮動小数点数からの場合は arithmetic error

  2. tripleへ収まらない場合には下記のように処理する
  - 係数部分の桁数が38桁を越える場合は末尾の桁を削り指数を増やす(truncate, 精度は失われる)
    - `DECIMAL(p,s)` の場合と異なり999...99への丸めは行わない
      - 999...99が最も近い数値とはかぎらないため
      - 例えば1000...00はreduceすれば桁数が1になる
  - 指数部分がtripleのサポートする範囲を越える場合はエラー
    - 変換でこれが起こる可能性があるのは文字列からの変換のみであり、format errorとする
    - 他の数値型は絶対値が比較的に小さな指数しか表現できない

### `DECIMAL(*,*)` の数値型への変換

- `DECIMAL(*,*)`の値が変換先の範囲に収まらない場合は、範囲の最大値・最小値を結果とする
  - 変換先がfloat4/float8の場合は+INF/-INFまたは+0.0/-0.0が結果となる。(参照[浮動小数へ変換時のunderflow/overflow](浮動小数へ変換時のunderflow/overflow))

- 変換先が `DECIMAL(p,s)` の場合、precision `p` と `s`に適合するように変換する。以下簡単のために正の数についてのみ述べる。
  - 整数部分が `p-s` 桁に収まらない場合は `99...999` ( `p-s`桁の整数部と`s`桁の小数部)を変換結果とする。精度は失われる。
  - 小数部分が `s` 桁に収まらない場合は収まるまで末尾の桁を `0`方向へroundingする(truncate)。末尾が0でない場合は精度が失われる。
      - 繰り上がりをすると桁あふれの処理が大変なので常に0方向へのrounding(truncate)とする

  - 実装メモ：
    1. `DECIMAL(*,*)`の数値を指数によって決まる小数点の位置により、桁を整数部分と小数部分に分割して考える。厳密には、十進数の数字のシーケンス「整数部」と「小数部」を下記のように定義する。係数に10の指数乗を掛けたものを十進数の数字とたかだか1個の小数点からなる列として表現し、小数点より左側を整数部、右側を小数部と呼ぶ。整数部が0である場合を除き、整数部はleading zeroを持たないが、小数部はtrailing zeroを持つことがある。整数部の長さは1以上、小数部は0以上である。以下、この表現によるものを係数とその整数部、小数部のように呼ぶ。

    2. 整数部が`p-s`桁で表現可能な数値へ丸めるため下記手順を実行する

      2-1. 整数部の桁数が`p-s` 以下であれば3へすすむ

      2-2. 整数部分の桁数が `p-s` より大きい場合は `p` 個の9を並べた数値を `x` とし、係数を`x`、指数を`-s`で置き換えた数値を結果とし完了する(3は不要)
    3. 小数部が`s`桁で表現可能な数値へ丸めるため下記手順を実行する

      3-1. 係数の小数部分の桁数が `s` 以下であれば完了、そうでなければ3-2へ
      3-2. 係数の末尾が小数部分であれば係数末尾の桁を取り除く
      3-3. 係数の小数部分の桁数が `s` 以下でになるまで3-2を繰り返す。

[キャスト]: https://github.com/project-tsurugi/takatori/blob/master/docs/ja/scalar-expressions-and-types.md#%E3%82%AD%E3%83%A3%E3%82%B9%E3%83%88%E5%A4%89%E6%8F%9B

[代入変換]: https://github.com/project-tsurugi/takatori/blob/master/docs/ja/scalar-expressions-and-types.md#%E4%BB%A3%E5%85%A5%E5%A4%89%E6%8F%9B
