# ロギング方針

2021-11-26 kurosawa

## この文書について

glogを使ってログメッセージを出力するコンポーネントについて、メッセージ種類やログレベル等について意識を合わせる

## 本文書の対象

- DBMSのサーバープロセスで稼働するコードで、共有されるロガー(glog)を使用してロギングメッセージを出力するもの
- サンプルコード、テストコード、ベンチマーク用コード、クライアントなどは対象外
- デバッグビルドでのみ出力されるログメッセージ(`DVLOG`によるものなど)は対象外

## 目標

- 運用(長時間稼働)・開発・デバッグ時にDBMSのログメッセージのレベルを設定し、適切な分量・粒度による出力によって確認できるようにする
- 特に、過剰な量のメッセージによって重要なものが隠れることを防ぐ

このための方針をコンポーネント間で共有し齟齬がないようにする。(glogの設定がプロセスワイドに必要なため)

## 基本的な方針

- DBMSのサーバープロセスの状態やその継続的な稼働にインパクトのある事象に関するメッセージは`LOG()`マクロを使用する(運用ログ)
  - デフォルトの構成でログメッセージとして出力される
- 単発のリクエストの処理に関するメッセージやepoch毎の定期的なイベントなどは`VLOG()`マクロを使用してverboseログとして表示する(イベントログ)
  - `GLOG_v`環境変数や`--v`オプションで明示的にverbose log levelを高くすることで出力される
- 原則としてログメッセージの出力に標準出力・標準エラー出力は使用しない
  - loggerと異なり細かい調整ができない
  - loggerが標準エラー出力へリダイレクトしてモニタリングすることもあるため衝突を避ける
- コンポーネント名を先頭に含む文字列をプレフィックスとして付加し、コンポーネントごとのログを収集可能にする
  - コンポーネントを絞って出力する機能がglogにないため、収集側で選択可能にするための対応

## ログレベル

ログレベルの一覧を下記のように定義し、対象となるコンポーネント間で共有する
ただし各ログレベルで表示されるメッセージに関する記述はおおまかな方針であり、細かい線引きは各コンポーネントに任せられる

### 運用ログ

`glog/logging.h`で定義される`ERROR`/`WARNING`/`INFO`レベルを使用して`LOG()`マクロで出力する

#### `ERROR` 

DBMSサーバープロセスとして継続して動作する上での問題の報告
異常系の処理の報告で通常、運用者・管理者のアクションを求める
例：構成の問題(矛盾するオプションの指定など)、リソースの枯渇など

#### `WARNING`

DBMSサーバープロセスとして継続して動作する上での警告

#### `INFO`

DBMSサーバープロセスの情報提供を目的としたメッセージ
例：起動メッセージ、構成オプション、リソースの情報など

### イベントログ

- `VLOG()`マクロに渡すログレベルの数値を下記のように10〜50の値で定義する
- コンポーネントごとにこれらを定数として定義するファイルを用意する
例：https://github.com/project-tsurugi/jogasaki/blob/master/include/jogasaki/logging.h
- ログレベルの数字は対象コンポーネント間で同じものを使用する
- 定義ファイルの共有はレポジトリ間の依存関係を発生させるので避ける
- 緊急時対応で間を利用できるように10飛びの値にしている

#### log level 10 (error)
  単発のイベントやリクエストに対する問題の報告
  イベントやリクエスト処理における異常系の処理の報告
  通常、原因となったリクエストやイベントを成功させるために何らかのアクションが求められる
#### log level 20 (warning)
  単発のイベントやリクエストに対する警告
#### log level 30 (info)
  情報提供を目的としたメッセージ
#### log level 40 (debug)
  より詳細な開発者向けデバグ情報の提供を目的としたメッセージ
#### log level 50 (trace)
  さらに詳細な情報の提供を目的としたメッセージ

## ロケーションプレフィックス

ソースコードにおけるログメッセージの出力位置を表すプレフィックスを下記フォーマットで定義する

```
/:<component>:<member_locator>
```

- `<component>` はコンポーネント名(`jogasaki`, `sharksfin`, `tateyama`など)
- `<member_locator>` はコンポーネント内でログの出力位置を特定可能な文字列
  - 衝突を避けるため、下記のようにC++名前空間の識別子ベースで先頭部分を作成する事を推奨
  - C++名前空間の識別子において区切り文字列(`::`)をコロン1個(`:`)にする
    - `namespace xxx::yyy::zzz` -> `xxx:yyy:zzz`
  - 末尾にコロン区切りで関数名・スコープ名などを追加してもよい
    - `xxx:yyy:zzz:func1`
  - `<member_locator>`に出現する文字は下記に限定する
    - アルファベット大文字(`A-Z`)、小文字(`a-z`)、数字(`0-9`)、アンダースコア(`_`)、ハイフン(`-`)
    - (区切り文字として)コロン(`:`)
  
- 例 
  `/:jogasaki:api:impl:database`

- プレフィックスとメッセージ本文の間には1個以上の空白があるようにして出力する
- ログメッセージに可能な限りこのプレフィックスを付加し、ソースコードのどの部分から出力されたメッセージかを明示する
- 文字列の前方一致検索でフィルターすることで、特定のコンポーネントのメッセージを抜き出せる

## 参考

### ログの表示方法

`tateyama-server`をDBMSを起動するためのコマンドとする。

- デフォルト

  ```
  $ ./tateyama-server
  ```
  デフォルトのログレベルで起動。DBMSプロセスの稼働に影響がある情報(運用ログ)のみがログメッセージとして出力される

- warningイベントログ
  ```
  $ GLOG_v=20 ./tateyama-server
  ```
  上記に加えてリクエストごとの警告やエラーも出力される(イベントログ)

- 運用エラーログのみ
  ```
  $ GLOG_minloglevel=2 ./tateyama-server
  ```
  運用ログレベルをERRORに設定し、ERROR以上のseverityのメッセージのみをログに出力する。(イベントログは出力しない)

## glogの考慮点・メモ
- 当面glogを使うことになりそうだが、本番環境で運用時もglogを使用するのかは別途検討する必要がある
  - ファイル名レベルでしかfilteringが効かないので、コンポーネントごとにon/offができない
- LOG(FATAL)はプロセスを終了させるので使用できる局面は限定的
- VLOG(0)は使用しないほうがいい。デフォルトはverbose level=0なのでLOG(INFO)と同じ意味になる
- VLOGによる出力はINFOレベルで表示される。verbose levelを0より大きく設定するとともに、minloglevelもINFO(1)以上にする必要がある