# BLOB 参照タグに関するメモ

2025-12-14 kurosawa

## 本文書について

BLOBのアクセスコントロールの実装において追加された内部設計のうち、特に備忘として残したいものをまとめる

## 前提

TsurugiにおけるBLOBのアクセスコントロールに関する下記issueのデザイン文書を前提知識とする

[BLOBのアクセスコントロール](https://github.com/project-tsurugi/tsurugi-issues/issues/1337)

## BLOB参照タグ

- BLOBアクセスコントロールはBLOB参照タグを既存のBLOB参照に追加する
- 参照タグはverification tokenの一種であり、BLOB IDが連番のようなシンプルな採番ルールだった場合に推測されることを避けるためのもの
- 信頼された内部から信頼されない外部にBLOB IDを送信する際、参照タグもセットで送信する
- 信頼されない外部からBLOB IDを受信した際、参照タグを使ってBLOB IDの真正性の確認を行う。これ以降、内部ではそのBLOB IDは真正であるものとして扱う
- 内部的には参照タグはIDの真正性確認に使用するのみで保管しておく意味はあまりなく、IDや通信路の接続情報等から簡単に計算できることが望ましい
- 逆に外部はBLOB IDと参照タグを一緒にして受取り、使用時のために一緒に保管しておく必要がある

## BLOB IDの交換と真正性の確認

- 今回のBLOBアクセスコントロール機能において、BLOB IDの真正性の確認が必要となる内部と外部の境界は下記の通りである
  - jogasaki APIを境界としたjogasakiのクライアントとサービス
    - サービスは結果セットのBLOB/CLOBフィールドでIDとタグを戻し、クライアントは `sql.proto.GetLargeObjectData` を使ってデータ本体を取得する
  - UDF呼出部分を境界としたjogasaki本体とUDF
    - jogasakiがUDFを呼出しBLOB/CLOB型の関数引数を渡す際、IDとタグを渡す、UDFの関数本体はこの情報を使って中継サービス経由でデータ本体を取得する
      - 現状ではここで渡されるBLOB参照は provider = datastoreのもののみ
        - IDの偽造によりデータストアのデータが読み取られないように参照タグで防ぐ 
      - 将来的には provider = data_relay_service のものも読めてもよいという話がある
    - UDFがBLOB/CLOB型の戻り値を返す際、中継サービスのBLOBセッションにBLOBを保存しそのIDを戻す
      - ここでは参照タグの交換は必須ではない (*1)
      - そのIDが真正でないものだったとしても、アクセスできるのはセッションに格納されたBLOBデータのみ
      - セッション上のBLOBデータはUDFによって生成したものなので読めても問題ない

## 当初の検討案

- 当初案では `lob::lob_reference` にタグを保持させることも検討したが、上記(*1)により一時的ににしてもjogasaki側がタグを保管する必要性はないために不要と判断した

## その他・注意事項

- UDFを呼び出す際、現在の前提では引数はデータストア経由、戻り値はセッション経由だが、これは必ずしもそうでなくてもいいという話があり将来的に変更があるかもしれない
  - 引数をセッション経由で渡す場合、データストアのblob idを読み取ってどこかで一旦セッションに追加する必要がある
  - 戻り値をデータストア経由にする場合、アップロード時にアサインされた参照タグをjogasaki側まで渡す必要がある
    - ただしこの場合、そもそもデータストアに再度仮登録というステップが不要になる可能性もあるので、やはり参照タグは不要かもしれない


