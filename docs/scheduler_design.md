# スケジューラーによるステップの状態管理

## この文書について

ステップスケジューラー(DAGコントローラー)から見たステップグラフのメンタルモデルとその状態管理について整理する
DAGコントローラの視点の操作を主に記述し、Executorの内部実装は別文書で述べる

## メンタルモデル・用語

### ステップグラフ
ステップを頂点とするDAG
ただし頂点どうしが直接辺でつながるのではなく、ポート(下記参照)を介して辺が接続する
有向辺によってデータを供給するステップと供給されるステップの関連を表す
あるステップに対して直接データを供給するステップを上流のステップと呼び、直接データを供給されるステップを下流のステップと呼ぶ

### ステップ
ステップグラフの頂点
DAGコントローラからはステップがexchangeかprocessかは区別しない

### ポート
ステップは0個以上の入力ポートと0個以上の出力ポートをもつ
入力ポートは1個以上の上流ステップの出力ポートに接続し、出力ポートは1個以上の下流ステップの出力ポートに接続する
入力ポートには主入力ポートと副入力ポートがある。副入力は主入力の処理に必要な入力であり、主入力よりも先に処理されるべきものを示す。

ステップと同様に、ポートについても直接接続しているステップをポートの上流または下流のステップと呼ぶ
全入力ポートの上流のステップをあわせたものがステップの上流のステップになる。

あるポートに対する接続先ポートは複数とることも可能である。例えばエクスチェンジの入力ポートは複数プロセスの出力ポートと接続可能でこの場合は複数プロセスの出力をunionとして受け取るセマンティクスであり、エクスチェンジの出力ポートを複数のプロセスの入力ポートと接続する場合はコピーして複数プロセスへ出力するというセマンティクスになる。*ただし以下ではプロセスに関しては入出力ポートの接続先はそれぞれ1つに限ると仮定する*

## 状態

DAGコントローラが管理する各ステップの状態を下記に示す

- CREATED
作成直後の初期状態である。静的な情報だけを持つ
- ACTIVATED
データフローの状態を管理する動的な状態変数やコンテキストがステップ内に作成された状態であり
上流・下流の状態変化が当ステップに影響を与えうる
- PREPARING
副入力の処理を実行中である
- PREPARED
副入力の処理を完了した
- RUNNING
主入力の処理を実行中である。この時点で下流に提供するデータのパーティション数が決定する
- COMPLETING
ステップの停止処理を開始した
- COMPLETED
ステップの全ての処理が完了した
- DEACTIVATED
データフローの状態を管理する状態変数やコンテキストが解放された

これらの状態は全順序をなす。
複数の状態をまとめて表すときには{}内にリストする。また、(x, y), [x, y), (x, y], [x,y]などの区間記号で表すこともある。"("と")"は端点を含まず、"["と"]"は端点を含む区間を表す。
例えば[ACTIVATED, RUNNING)は{ACTIVATED, PREPARING, PREPARED}を表す

便宜上ポートの状態を、接続するステップの状態を用いて下記のように定める
入力ポート
- inactive
入力ポートが接続する上流のステップ全てが[CREATED, PREPARED]のいずれかである
入力ポートにデータが供給されない状態を表す
- completed
入力ポートが接続する上流のステップ全てが{COMPLETED, DEACTIVATED}のいずれかである
入力ポートへのデータ供給が完了した状態を表す
- active
inactiveでもcompletedでもない状態
入力ポートにデータが供給され得る状態を表す

出力ポート
- inactive
出力ポートが接続する下流ステップ全てがCREATEDである
出力ポートにデータが供給できない状態を表す
- active
出力ポートが接続する下流のステップのうち少なくとも1つがCREATED以外である
出力ポートにデータを供給可能な状態を表す

## DAGコントローラのタスク状態管理

DAGコントローラは各ステップごとにsubstateとして関連タスクの状態を管理する
関連タスクとは主入力を処理するタスク(主タスク)または副入力を処理するタスク(副タスク)である
タスクの状態はuninitialized(作成直後の状態), running(実行中), completed(完了)の3つがあり、DAGコントローラーはタスクごとにスロットを作成してこの状態を保存する

状態管理は下記の手順からなる

- タスクスロットの追加
ステップの完了に必要なタスクを特定し、そのステートやハンドルを管理するスロットを必要な個数分作成する。ステートの初期値はuninitializedとする。この手順は副入力についてはACTIVATEDへの遷移中に、主入力についてはRUNNINGへの遷移中に行われる

- タスクを開始(タスクスケジューラー(下記参照)に委譲)してスロットにrunning状態を保存
- タスクの終了通知を受けてスロットの状態をcompletedへ更新

## タスクスケジューラー

DAGコントローラはタスク実行をタスクスケジューラーに依頼する
タスクスケジューラーはスレッドやCPU資源に関する知識を持ち適切なスレッドでタスクを実行する
タスクはその判断で中断状態(waiting)になることができる。この状態はタスク・タスクスケジューラ内部の状態でありDAGコントローラーは知らない。中断状態のタスクはスレッドでは実行されずCPUリソースは消費しない。
タスクスケジューラーへタスクハンドルとともに指示することで中断状態のタスクを再実行することが可能である。

### タスクへの早期終了指示
タスクスケジューラへ渡された未完了のタスクは実行中か中断状態のいずれかである。いずれの場合も、タスクスケジューラーにタスクハンドルとともに指示することによってタスクの早期終了処理を開始することができる。タスクの実装は終了処理を指示されたら速やかに入力からの読み出しを停止し、リソースのクリーンアップなど必要な終了処理を行ってタスクを終了すべきである。

## イベント

DAGコントローラが外部(ステップグラフ、タスク等)から受け取るイベントは下記のとおり

- preparation completed(外部)
副タスク完了通知
DAGコントローラはこのイベントによって副タスクの完了を知る。副タスク(複数ある可能性もある)が全部完了した場合にPREPAREDステートに遷移させる。
- main completed(外部)
主タスク完了通知
DAGコントローラはこのイベントによって主タスクの完了を知る。主タスクが全部完了し入力がこれ以上ないという場合にCOMPLETEDステートに遷移させる。
- upstream providing(外部)
上流がデータ送信を開始したのでタスクの作成が必要かもしれないという通知
DAGコントローラはステップにタスク作成を要求する。ステップの判断で0個以上のタスクが作成されるのでその個数によってDAGコントローラは状態を遷移させる。状態に変更がない事もある。
- completion instructed(外部)
ステップ処理の早期完了要求通知
何らかの理由によりターゲットステップの処理を早期に終了させたいという通知
DAGコントローラはタスクを特定し、タスクスケジューラーに早期終了を要求する