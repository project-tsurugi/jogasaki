# Jogasaki SQL実行エンジン API解説文書

## 1. はじめに

本書は、Jogasaki SQL実行エンジンの開発および保守に関わるエンジニア向けに、提供機能、API設計、およびモジュール構造を説明することを目的とする。

---

## 2. 主要API

Jogasaki SQL実行エンジンが提供する API は、Protocol Buffers を用いて定義されており、以下のファイルによって構成されている：

- `src/jogasaki/proto/sql/request.proto`：API 呼び出しにおけるリクエスト メッセージを定義する
- `src/jogasaki/proto/sql/response.proto`：それぞれのリクエストに対応するレスポンス メッセージを定義する

以下では、API が提供する機能の概要と、Protocol Buffers で定義された各メッセージについて説明する。

### 2.1 ステートメント／クエリ実行 API

SELECT や INSERT などの SQL ステートメントやクエリをサポートする。クエリはトランザクションの文脈で評価され、結果はクライアントへ外部チャネル経由で返却される。ステートメントのプリペアド実行とパラメータ指定による再利用も可能である。

Jogasaki では、結果セットを返すクエリ（例：SELECT）と、結果セットを返さないステートメント（例：INSERT、UPDATE、DDL など）を区別し、それぞれ専用の API を用いて実行する設計となっている。

#### クエリの実行（結果セットを返す）

- **Prepare** – SQL クエリをプリペアドステートメントとして登録する。
- **ExecutePreparedQuery** – 準備済みのクエリを、パラメータを指定して実行する。
- **ExecuteQuery** – 単発の SQL クエリを直接実行する。

> ※ クエリ実行の結果セットは、呼び出しの戻り値ではなく、別途確立された結果セット用チャネルを通じて送信される。大量データ処理時の効率性を考慮した設計である。

#### ステートメントの実行（結果セットを返さない）

- **ExecutePreparedStatement** – プリペアドステートメント形式で準備された非クエリ ステートメントを実行する。
- **ExecuteStatement** – 単発の非クエリ ステートメントを即時実行する。

> ※ これらのステートメントは結果セットを返さないため、チャネルを介した結果出力は行われない。

---

### 2.2 トランザクション管理 API

アプリケーションがトランザクションの開始、終了（コミット／ロールバック）、および状態確認を明示的に制御できる。すべてのクエリは特定トランザクションに紐づいて実行される設計となっている。

- **Begin** – 新しいトランザクションを開始する。実行後にトランザクション ID が払い出される。
- **Commit** – 実行中のトランザクションをコミットし、確定処理を行う。
- **Rollback** – 実行中のトランザクションを取り消す（ロールバックする）。
- **GetTransactionStatus** – 指定したトランザクションの現在の状態（実行中、完了済み など）を取得する。

---

### 2.3 ダンプ／ロード API

テーブル データを外部ファイルにダンプしたり、ファイルからロードしたりする。ファイル形式は Apache Arrow や Apache Parquet を想定し、データ退避・初期投入・他システム連携に活用できる。

- **ExecuteDump** – テーブル データを外部ファイルにダンプする。
- **ExecuteLoad** – 外部ファイルの内容をロードし、テーブルに書き込む。スキーマ整合性の検証も行う。

---

### 2.4 メタデータ参照 API

テーブルの定義情報やデータベース内のテーブル一覧などのメタデータを取得できる。クライアント アプリケーションはスキーマ構造を動的に取得して利用可能。

- **DescribeTable** – 指定されたテーブルの構造情報（列名、型など）を取得する。
- **ListTables** – スキーマに含まれるすべてのテーブルの一覧を取得する。

---

### 2.5 EXPLAIN API

SQL ステートメントに対して、実行前に論理／物理プランを可視化する EXPLAIN 機能を提供。クエリの構造や実行経路を確認する用途に利用される。

- **Explain** – プリペアド済みまたは直接指定された SQL に対して、論理または物理プランを生成し返却する。
- **ExplainByText** – SQL 文字列を入力として、論理プランまたは物理プランを取得する。軽量な事前分析用途で利用される。

---

## 3. クエリ出力チャネルと結果転送設計

Jogasaki SQL 実行エンジンでは、クエリ（例：SELECT）の実行結果を返す際、API 呼び出しの戻り値とは別に **結果セット用のチャネル** を用いてクライアントに送信する設計となっている。

### 3.1 出力チャネルの概要

クエリ実行の結果は、呼び出し元関数の戻り値としてではなく、別途確立された **結果セット用のチャネル** を通じて送信される。

### 3.2 対象となるクエリの範囲

この出力チャネルを使用するのは、論理プラン上に **Emit 演算子** を含むクエリである。

---

## 4. 内部構造とモジュール間の責務

### 4.1 主な構成モジュールと役割

- **SQL コンパイラ** – SQL 文を解析し、論理クエリプランを構築・最適化する。
- **jogasaki** – 論理プランを物理プランに変換し、並列処理可能な実行パイプラインを構築する。
- **タスクスケジューラー** – 実行計画中の演算子間の依存関係をもとに、各オペレータの実行順序およびワーカースレッドへの割り当てを管理する。
- **トランザクション エンジン** – 実行時におけるデータの読み書きや一貫性の制御を担当する。物理プラン内の関係演算子は、このトランザクション エンジンを介してデータアクセスを行う。
- **結果転送層** – 結果セット用チャネルを通じて、クエリ結果をクライアントに送信する。

### 4.2 モジュール間の処理フロー

1. SQL 文は SQL コンパイラで解析され、論理プランに変換される。
2. 論理プランは jogasaki で物理プランに変換される。
3.タスクスケジューラーが依存関係を解析し、実行順とスレッドを決定。
4. 各関係演算子はトランザクション エンジンを介してデータを処理する。
5. 結果は結果転送層を通じてチャネルで送信される。
