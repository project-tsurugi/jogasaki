# リレーショナルデータ保存形式

version: 1 (umikongo)

version: 2 (2020-11 kurosawa jogasaki用に修正)

## この文書について

* sharksfin を利用してリレーショナルデータを格納するためのデータフォーマットを規定する

## 制約

* キーの大小関係
  * `NULL` は常に他のあらゆる値よりも小さい
* テーブル
  * 主キーを構成する属性は、いずれかが非 `NULL` の値でなければならない
* インデックス
  * インデックスキーを構成する属性がすべて `NULL` となるような行は、インデックスに登録されない
* ストレージ
  * キーは固定長または可変長
  * ペイロードは可変長
  * キーに対してペイロードは1個または2個以上
  * キーは `unsigned char[]` の辞書式順序に整列

## データ形式

### テーブル(プライマリインデックス)

* キー
  * 主キーの各属性をキーエンコーディングによってバイト列に変換したものを格納
* ペイロード
  * 主キーを除いたテーブル属性をペイロードエンコーディングによってバイト列に変換したものを格納

### インデックス(セカンダリインデックス)

* キー
  * インデックスキーと主キーの各属性をそれぞれキーエンコーディングし、インデックスキー、主キーの順て連接したバイト列
* ペイロード
  * セカンダリインデックスが特定の列の値を保持する場合(e.g. CREATE INDEX ... INCLUDE ...)、その列に対応する属性をペイロードエンコーディングによってバイト列に変換し連接したものを格納
  * 上記以外の場合、ペイロードは空

## キーエンコーディング

* キーの各属性を型ごとに定められた形式でエンコーディングし、それらを属性の順に連接したもの

### boolean values

* エンコード形式
  * `true`
    * `uint_8` の `1` として格納
  * `false`
    * `uint_8` の `0` として格納

### integral numbers

* エンコード形式
  * 符号なし
    * ビッグエンディアンで格納
  * 符号あり
    * 符号ビットを反転し、ビッグエンディアンで格納

### floating point numbers

* エンコード形式
  * `>= 0`
    * 符号ビットを反転したバイト列をビッグエンディアンで格納
  * `< 0`
    * すべてのビット列を反転したバイト列をビッグエンディアンで格納
  * `NaN`
    * 符号を1, 特殊ペイロードを0-fillしたバイト列をビッグエンディアンで格納

### character strings

* エンコード形式
  * 文字列データのバイト列に既定の終端文字列を連接して格納する

### nullable values

* エンコード形式
  1. `u1 present`
     * 値が存在するかどうか
       * `0` - 存在しない
       * `1` - 存在する
  2. `T value`
     * 実際の値 (値が存在する場合のみ)
       * key encoded value - 実際の値
     * 値が存在しない場合、`value`も存在しない

### ascendant/descendant order

* エンコード形式
  * 昇順
    * そのまま格納する
  * 降順
    * バイト列のすべてのビットを反転して格納する

## ペイロードエンコーディング

* 本文書ではペイロードについて特定のエンコーディングは規定しない(実装依存)。
  * 比較・ソート順序に関する制約がないため、属性の値とバイト列間で効率よく相互変換できるものであれば何でも良い。
